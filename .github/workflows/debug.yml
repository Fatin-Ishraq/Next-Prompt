name: Debug Facebook Posting

on:
  workflow_dispatch: # Manual trigger only

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install requests python-dotenv supabase
      
      - name: Debug Environment
        env:
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          supabase_url: ${{ secrets.SUPABASE_URL }}
          supabase_key: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "===== DEBUG INFO ====="
          echo "FB_PAGE_ID length: ${#FB_PAGE_ID}"
          echo "FB_PAGE_ID hex dump:"
          echo -n "$FB_PAGE_ID" | xxd
          echo "Supabase URL set: $(if [ -n "$supabase_url" ]; then echo YES; else echo NO; fi)"
          echo "======================"
      
      - name: Test Facebook Post
        env:
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          supabase_url: ${{ secrets.SUPABASE_URL }}
          supabase_key: ${{ secrets.SUPABASE_KEY }}
        run: |
          python << 'EOF'
          import os
          import requests
          from supabase import create_client

          # Get Page ID and check for issues
          page_id = os.getenv("FB_PAGE_ID", "")
          print(f"Page ID raw: '{page_id}'")
          print(f"Page ID repr: {repr(page_id)}")
          print(f"Page ID stripped: '{page_id.strip()}'")
          
          # Use stripped version
          page_id = page_id.strip()
          
          # Get token from Supabase
          supabase_url = os.getenv("supabase_url", "")
          supabase_key = os.getenv("supabase_key", "")
          
          print(f"\nConnecting to Supabase...")
          client = create_client(supabase_url, supabase_key)
          
          result = client.table("context").select("*").eq("key", "fb_page_token").execute()
          if result.data:
              token = result.data[0]["value"]
              print(f"Token found: ...{token[-15:]}")
          else:
              print("ERROR: No token in Supabase!")
              exit(1)
          
          # Test post
          print(f"\nPosting to page {page_id}...")
          url = f"https://graph.facebook.com/v19.0/{page_id}/photos"
          payload = {
              "url": "https://picsum.photos/800/800",
              "caption": "ðŸ§ª GitHub Actions debug test",
              "access_token": token
          }
          
          response = requests.post(url, data=payload, timeout=30)
          print(f"Status: {response.status_code}")
          print(f"Response: {response.text}")
          
          if response.status_code == 200:
              print("\nâœ… SUCCESS!")
          else:
              print("\nâŒ FAILED")
          EOF
